name: Lint and Test Chart

on:
  pull_request:
    paths:
      - 'charts/**'
  push:
    branches:
      - master
    paths:
      - 'charts/**'
  workflow_dispatch:

jobs:
  lint-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          # renovate: datasource=github-releases depName=helm/helm
          version: 'v3.19.2'

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.8.0

      - name: Install tools
        run: |
          # helm-unittest
          helm plugin install https://github.com/helm-unittest/helm-unittest.git

          # JSON schema validator
          pip install check-jsonschema

          # Artifact Hub CLI
          # renovate: datasource=github-releases depName=artifacthub/hub
          AH_VERSION="1.21.0"
          wget --quiet https://github.com/artifacthub/hub/releases/download/v${AH_VERSION}/ah_${AH_VERSION}_linux_amd64.tar.gz
          tar --extract --gzip --file ah_${AH_VERSION}_linux_amd64.tar.gz
          chmod +x ah
          sudo mv ah /usr/local/bin/ah

          # helm-docs
          # renovate: datasource=github-releases depName=norwoodj/helm-docs
          HELM_DOCS_VERSION="1.14.2"
          wget --quiet https://github.com/norwoodj/helm-docs/releases/download/v${HELM_DOCS_VERSION}/helm-docs_${HELM_DOCS_VERSION}_Linux_x86_64.tar.gz
          tar --extract --gzip --file helm-docs_${HELM_DOCS_VERSION}_Linux_x86_64.tar.gz
          chmod +x helm-docs
          sudo mv helm-docs /usr/local/bin/helm-docs

          # markdownlint-cli2
          npm install --global markdownlint-cli2

      - name: Run Helm Lint
        run: |
          echo "Running Helm lint..."
          # Default values (gatewayClassConfig.create: false) require no additional sets
          helm lint charts/cloudflare-tunnel-gateway-controller

      - name: Run Helm Unittest
        run: |
          CHART_DIR="charts/cloudflare-tunnel-gateway-controller"
          if [ -d "$CHART_DIR/tests" ]; then
            echo "Running unit tests..."
            helm unittest "$CHART_DIR" --color --with-subchart=false
          else
            echo "No tests directory found, skipping unit tests"
          fi

      - name: Run chart-testing (lint)
        run: |
          echo "Running chart-testing lint..."
          ct lint --charts charts/cloudflare-tunnel-gateway-controller

      - name: Run Artifact Hub Lint
        run: |
          echo "Running Artifact Hub lint..."
          ah lint --kind helm --path charts/cloudflare-tunnel-gateway-controller

      - name: Validate JSON Schema
        run: |
          CHART_DIR="charts/cloudflare-tunnel-gateway-controller"
          if [ -f "$CHART_DIR/values.schema.json" ]; then
            echo "Validating values.yaml against schema..."
            check-jsonschema --schemafile "$CHART_DIR/values.schema.json" "$CHART_DIR/values.yaml"
          else
            echo "No values.schema.json found, skipping schema validation"
          fi

      - name: Template Chart
        run: |
          echo "Testing chart templating with default values..."
          # Default values (gatewayClassConfig.create: false) require no additional sets
          helm template test-release charts/cloudflare-tunnel-gateway-controller

      - name: Template Chart with GatewayClassConfig
        run: |
          echo "Testing chart with GatewayClassConfig enabled..."
          helm template test-release charts/cloudflare-tunnel-gateway-controller \
            --set gatewayClassConfig.create=true \
            --set gatewayClassConfig.tunnelID=550e8400-e29b-41d4-a716-446655440000 \
            --set gatewayClassConfig.cloudflareCredentialsSecretRef.name=cloudflare-credentials

      - name: Template Chart with cloudflared management
        run: |
          echo "Testing chart with cloudflared management enabled..."
          helm template test-release charts/cloudflare-tunnel-gateway-controller \
            --set gatewayClassConfig.create=true \
            --set gatewayClassConfig.tunnelID=550e8400-e29b-41d4-a716-446655440000 \
            --set gatewayClassConfig.cloudflareCredentialsSecretRef.name=cloudflare-credentials \
            --set gatewayClassConfig.tunnelTokenSecretRef.name=cloudflare-tunnel-token \
            --set gatewayClassConfig.cloudflared.enabled=true

      - name: Template Chart with ServiceMonitor
        run: |
          echo "Testing chart with ServiceMonitor enabled..."
          helm template test-release charts/cloudflare-tunnel-gateway-controller \
            --set serviceMonitor.enabled=true

      - name: Validate helm-docs
        run: |
          CHART_DIR="charts/cloudflare-tunnel-gateway-controller"
          echo "Validating README.md is up to date..."
          helm-docs "$CHART_DIR"

          if git diff --exit-code "$CHART_DIR/README.md" > /dev/null 2>&1; then
            echo "README.md is up to date"
          else
            echo "ERROR: README.md is out of date!"
            echo "Please run: helm-docs $CHART_DIR"
            echo ""
            echo "Diff:"
            git diff "$CHART_DIR/README.md"
            exit 1
          fi

      - name: Run Markdownlint
        run: |
          CHART_DIR="charts/cloudflare-tunnel-gateway-controller"
          if [ -f "$CHART_DIR/README.md" ]; then
            echo "Running markdownlint on README.md..."
            markdownlint-cli2 "$CHART_DIR/README.md"
          else
            echo "No README.md found, skipping markdownlint"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All validation tests completed for cloudflare-tunnel-gateway-controller chart" >> $GITHUB_STEP_SUMMARY
