name: Lint and Test Chart

on:
  pull_request:
    paths:
      - 'charts/**'
  push:
    branches:
      - master
    paths:
      - 'charts/**'
  workflow_dispatch:

jobs:
  lint-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.7.0

      - name: Install tools
        run: |
          # helm-unittest
          helm plugin install https://github.com/helm-unittest/helm-unittest.git

          # JSON schema validator
          pip install check-jsonschema

          # Artifact Hub CLI
          # renovate: datasource=github-releases depName=artifacthub/hub
          AH_VERSION="1.21.0"
          wget --quiet https://github.com/artifacthub/hub/releases/download/v${AH_VERSION}/ah_${AH_VERSION}_linux_amd64.tar.gz
          tar --extract --gzip --file ah_${AH_VERSION}_linux_amd64.tar.gz
          chmod +x ah
          sudo mv ah /usr/local/bin/ah

      - name: Run Helm Lint
        run: |
          echo "Running Helm lint..."
          helm lint charts/cloudflare-tunnel-gateway-controller \
            --set cloudflare.tunnelId=test-tunnel-id \
            --set cloudflare.apiToken=test-api-token

      - name: Run Helm Unittest
        run: |
          CHART_DIR="charts/cloudflare-tunnel-gateway-controller"
          if [ -d "$CHART_DIR/tests" ]; then
            echo "Running unit tests..."
            helm unittest $CHART_DIR --color --with-subchart=false
          else
            echo "No tests directory found, skipping unit tests"
          fi

      - name: Run chart-testing (lint)
        run: |
          echo "Running chart-testing lint..."
          ct lint --charts charts/cloudflare-tunnel-gateway-controller \
            --chart-yaml-schema /dev/null \
            --lint-conf /dev/null

      - name: Run Artifact Hub Lint
        run: |
          echo "Running Artifact Hub lint..."
          ah lint --kind helm --path charts/cloudflare-tunnel-gateway-controller

      - name: Validate JSON Schema
        run: |
          CHART_DIR="charts/cloudflare-tunnel-gateway-controller"
          if [ -f "$CHART_DIR/values.schema.json" ]; then
            echo "Validating values.yaml against schema..."
            check-jsonschema --schemafile "$CHART_DIR/values.schema.json" "$CHART_DIR/values.yaml"
          else
            echo "No values.schema.json found, skipping schema validation"
          fi

      - name: Template Chart
        run: |
          echo "Testing chart templating..."
          helm template test-release charts/cloudflare-tunnel-gateway-controller \
            --set cloudflare.tunnelId=test-tunnel-id \
            --set cloudflare.apiToken=test-api-token

      - name: Template Chart with manageCloudflared
        run: |
          echo "Testing chart with manageCloudflared enabled..."
          helm template test-release charts/cloudflare-tunnel-gateway-controller \
            --set cloudflare.tunnelId=test-tunnel-id \
            --set cloudflare.apiToken=test-api-token \
            --set manageCloudflared.enabled=true \
            --set manageCloudflared.tunnelToken=test-tunnel-token

      - name: Template Chart with ServiceMonitor
        run: |
          echo "Testing chart with ServiceMonitor enabled..."
          helm template test-release charts/cloudflare-tunnel-gateway-controller \
            --set cloudflare.tunnelId=test-tunnel-id \
            --set cloudflare.apiToken=test-api-token \
            --set serviceMonitor.enabled=true

      - name: Summary
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All validation tests completed for cloudflare-tunnel-gateway-controller chart" >> $GITHUB_STEP_SUMMARY
