suite: test servicemonitor
templates:
  - servicemonitor.yaml
tests:
  - it: should not create ServiceMonitor by default
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
    asserts:
      - hasDocuments:
          count: 0

  - it: should create ServiceMonitor when enabled
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      serviceMonitor:
        enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ServiceMonitor
      - equal:
          path: apiVersion
          value: monitoring.coreos.com/v1

  - it: should have correct name
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      serviceMonitor:
        enabled: true
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-cloudflare-tunnel-gateway-controller

  - it: should have standard labels
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      serviceMonitor:
        enabled: true
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: cloudflare-tunnel-gateway-controller
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  - it: should add custom labels when specified
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      serviceMonitor:
        enabled: true
        labels:
          prometheus: kube-prometheus
          team: platform
    asserts:
      - equal:
          path: metadata.labels.prometheus
          value: kube-prometheus
      - equal:
          path: metadata.labels.team
          value: platform

  - it: should select correct pods
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      serviceMonitor:
        enabled: true
    asserts:
      - equal:
          path: spec.selector.matchLabels["app.kubernetes.io/name"]
          value: cloudflare-tunnel-gateway-controller
      - equal:
          path: spec.selector.matchLabels["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  - it: should scrape metrics endpoint
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      serviceMonitor:
        enabled: true
    asserts:
      - equal:
          path: spec.endpoints[0].port
          value: metrics

  - it: should not set interval by default
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      serviceMonitor:
        enabled: true
    asserts:
      - isNull:
          path: spec.endpoints[0].interval

  - it: should set custom interval when specified
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      serviceMonitor:
        enabled: true
        interval: "30s"
    asserts:
      - equal:
          path: spec.endpoints[0].interval
          value: "30s"

  - it: should work with fullnameOverride
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      fullnameOverride: "custom-controller"
      serviceMonitor:
        enabled: true
    asserts:
      - equal:
          path: metadata.name
          value: custom-controller
