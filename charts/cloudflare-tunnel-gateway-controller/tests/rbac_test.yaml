suite: test rbac
templates:
  - serviceaccount.yaml
  - clusterrole.yaml
  - clusterrolebinding.yaml
tests:
  - it: should create a service account
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
    asserts:
      - template: serviceaccount.yaml
        isKind:
          of: ServiceAccount
      - template: serviceaccount.yaml
        equal:
          path: metadata.name
          value: RELEASE-NAME-cloudflare-tunnel-gateway-controller

  - it: should create a cluster role
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
    asserts:
      - template: clusterrole.yaml
        isKind:
          of: ClusterRole
      - template: clusterrole.yaml
        equal:
          path: metadata.name
          value: RELEASE-NAME-cloudflare-tunnel-gateway-controller

  - it: should have gateway api permissions
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
    asserts:
      - template: clusterrole.yaml
        contains:
          path: rules
          content:
            apiGroups: ["gateway.networking.k8s.io"]
            resources: ["gateways"]
            verbs: ["get", "list", "watch", "update", "patch"]
      - template: clusterrole.yaml
        contains:
          path: rules
          content:
            apiGroups: ["gateway.networking.k8s.io"]
            resources: ["httproutes"]
            verbs: ["get", "list", "watch"]
      - template: clusterrole.yaml
        contains:
          path: rules
          content:
            apiGroups: ["gateway.networking.k8s.io"]
            resources: ["gateways/status", "httproutes/status"]
            verbs: ["get", "update", "patch"]
      - template: clusterrole.yaml
        contains:
          path: rules
          content:
            apiGroups: ["gateway.networking.k8s.io"]
            resources: ["gatewayclasses"]
            verbs: ["get", "list", "watch"]

  - it: should create a cluster role binding
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
    asserts:
      - template: clusterrolebinding.yaml
        isKind:
          of: ClusterRoleBinding
      - template: clusterrolebinding.yaml
        equal:
          path: metadata.name
          value: RELEASE-NAME-cloudflare-tunnel-gateway-controller
      - template: clusterrolebinding.yaml
        equal:
          path: roleRef.name
          value: RELEASE-NAME-cloudflare-tunnel-gateway-controller
      - template: clusterrolebinding.yaml
        contains:
          path: subjects
          content:
            kind: ServiceAccount
            name: RELEASE-NAME-cloudflare-tunnel-gateway-controller
            namespace: NAMESPACE

  - it: should add service account annotations when specified
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      serviceAccount:
        annotations:
          eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/my-role"
    asserts:
      - template: serviceaccount.yaml
        equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: "arn:aws:iam::123456789012:role/my-role"

  - it: should use custom service account name when specified
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      serviceAccount:
        name: "my-custom-sa"
    asserts:
      - template: serviceaccount.yaml
        equal:
          path: metadata.name
          value: my-custom-sa
