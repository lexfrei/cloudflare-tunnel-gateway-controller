suite: test networkpolicy
templates:
  - networkpolicy.yaml
tests:
  - it: should not create NetworkPolicy by default
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
    asserts:
      - hasDocuments:
          count: 0

  - it: should create NetworkPolicy when enabled
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: NetworkPolicy
      - equal:
          path: metadata.name
          value: RELEASE-NAME-cloudflare-tunnel-gateway-controller

  - it: should have correct labels
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: cloudflare-tunnel-gateway-controller
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  - it: should select correct pods
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
    asserts:
      - equal:
          path: spec.podSelector.matchLabels["app.kubernetes.io/name"]
          value: cloudflare-tunnel-gateway-controller
      - equal:
          path: spec.podSelector.matchLabels["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  - it: should have both Ingress and Egress policy types
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
    asserts:
      - contains:
          path: spec.policyTypes
          content: Ingress
      - contains:
          path: spec.policyTypes
          content: Egress

  - it: should allow ingress on metrics port
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
      service:
        metricsPort: 8080
    asserts:
      - contains:
          path: spec.ingress[0].ports
          content:
            protocol: TCP
            port: 8080

  - it: should allow ingress on health port
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
      service:
        healthPort: 8081
    asserts:
      - contains:
          path: spec.ingress[0].ports
          content:
            protocol: TCP
            port: 8081

  - it: should allow ingress on custom ports
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
      service:
        metricsPort: 9090
        healthPort: 9091
    asserts:
      - contains:
          path: spec.ingress[0].ports
          content:
            protocol: TCP
            port: 9090
      - contains:
          path: spec.ingress[0].ports
          content:
            protocol: TCP
            port: 9091

  - it: should allow DNS egress UDP
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
    asserts:
      - contains:
          path: spec.egress[0].ports
          content:
            protocol: UDP
            port: 53

  - it: should allow DNS egress TCP
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
    asserts:
      - contains:
          path: spec.egress[0].ports
          content:
            protocol: TCP
            port: 53

  - it: should allow Kubernetes API egress
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
    asserts:
      - contains:
          path: spec.egress[1].ports
          content:
            protocol: TCP
            port: 443
      - contains:
          path: spec.egress[1].ports
          content:
            protocol: TCP
            port: 6443

  - it: should allow Cloudflare API egress
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
    asserts:
      - equal:
          path: spec.egress[2].to[0].ipBlock.cidr
          value: "0.0.0.0/0"
      - contains:
          path: spec.egress[2].ports
          content:
            protocol: TCP
            port: 443
