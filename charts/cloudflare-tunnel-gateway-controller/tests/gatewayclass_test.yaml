suite: test gatewayclass
templates:
  - gatewayclass.yaml
tests:
  - it: should create a gatewayclass by default
    asserts:
      - template: gatewayclass.yaml
        isKind:
          of: GatewayClass
      - template: gatewayclass.yaml
        isAPIVersion:
          of: gateway.networking.k8s.io/v1

  - it: should use default controller name
    asserts:
      - template: gatewayclass.yaml
        equal:
          path: metadata.name
          value: cloudflare-tunnel
      - template: gatewayclass.yaml
        equal:
          path: spec.controllerName
          value: cf.k8s.lex.la/tunnel-controller

  - it: should use custom gateway class name
    set:
      controller:
        gatewayClassName: "my-gateway-class"
        controllerName: "my.controller/name"
    asserts:
      - template: gatewayclass.yaml
        equal:
          path: metadata.name
          value: my-gateway-class
      - template: gatewayclass.yaml
        equal:
          path: spec.controllerName
          value: my.controller/name

  - it: should not create gatewayclass when disabled
    set:
      gatewayClass:
        create: false
    asserts:
      - template: gatewayclass.yaml
        hasDocuments:
          count: 0

  - it: should have correct labels
    asserts:
      - template: gatewayclass.yaml
        equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: cloudflare-tunnel-gateway-controller
      - template: gatewayclass.yaml
        equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  - it: should have managed-by label
    asserts:
      - template: gatewayclass.yaml
        equal:
          path: metadata.labels["app.kubernetes.io/managed-by"]
          value: Helm

  - it: should use gatewayClassName independent of release name
    set:
      controller:
        gatewayClassName: "fixed-class-name"
    asserts:
      - template: gatewayclass.yaml
        equal:
          path: metadata.name
          value: fixed-class-name

  - it: should have correct controllerName format
    set:
      controller:
        controllerName: "example.com/my-controller"
    asserts:
      - template: gatewayclass.yaml
        equal:
          path: spec.controllerName
          value: "example.com/my-controller"

  - it: should work with special characters in gatewayClassName
    set:
      controller:
        gatewayClassName: "cf-tunnel-prod-v1"
    asserts:
      - template: gatewayclass.yaml
        equal:
          path: metadata.name
          value: cf-tunnel-prod-v1

  - it: should have parametersRef when gatewayClassConfig is created
    set:
      gatewayClassConfig:
        create: true
    asserts:
      - template: gatewayclass.yaml
        equal:
          path: spec.parametersRef.group
          value: cf.k8s.lex.la
      - template: gatewayclass.yaml
        equal:
          path: spec.parametersRef.kind
          value: GatewayClassConfig
      - template: gatewayclass.yaml
        equal:
          path: spec.parametersRef.name
          value: RELEASE-NAME-cloudflare-tunnel-gateway-controller

  - it: should use custom gatewayClassConfig name
    set:
      gatewayClassConfig:
        create: true
        name: "my-custom-config"
    asserts:
      - template: gatewayclass.yaml
        equal:
          path: spec.parametersRef.name
          value: my-custom-config

  - it: should not have parametersRef when gatewayClassConfig is disabled
    set:
      gatewayClassConfig:
        create: false
    asserts:
      - template: gatewayclass.yaml
        notExists:
          path: spec.parametersRef
