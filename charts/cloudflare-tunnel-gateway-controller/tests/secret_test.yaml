suite: test secret
templates:
  - secret.yaml
tests:
  - it: should create a secret when apiToken is provided
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
    asserts:
      - template: secret.yaml
        isKind:
          of: Secret
      - template: secret.yaml
        equal:
          path: metadata.name
          value: RELEASE-NAME-cloudflare-tunnel-gateway-controller
      - template: secret.yaml
        equal:
          path: type
          value: Opaque

  - it: should not create a secret when apiTokenSecretName is provided
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiTokenSecretName: "my-existing-secret"
    asserts:
      - template: secret.yaml
        hasDocuments:
          count: 0

  - it: should include tunnel token when manageCloudflared is enabled
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      manageCloudflared:
        enabled: true
        tunnelToken: "test-tunnel-token"
    asserts:
      - template: secret.yaml
        exists:
          path: data["tunnel-token"]

  - it: should not include tunnel token when tunnelTokenSecretName is provided
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      manageCloudflared:
        enabled: true
        tunnelTokenSecretName: "my-tunnel-secret"
    asserts:
      - template: secret.yaml
        notExists:
          path: data["tunnel-token"]
