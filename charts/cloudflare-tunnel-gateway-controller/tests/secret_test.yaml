suite: test secret
templates:
  - secret.yaml
tests:
  - it: should create a secret when apiToken is provided
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
    asserts:
      - template: secret.yaml
        isKind:
          of: Secret
      - template: secret.yaml
        equal:
          path: metadata.name
          value: RELEASE-NAME-cloudflare-tunnel-gateway-controller
      - template: secret.yaml
        equal:
          path: type
          value: Opaque

  - it: should not create a secret when apiTokenSecretName is provided
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiTokenSecretName: "my-existing-secret"
    asserts:
      - template: secret.yaml
        hasDocuments:
          count: 0

  - it: should include tunnel token when manageCloudflared is enabled
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      manageCloudflared:
        enabled: true
        tunnelToken: "test-tunnel-token"
    asserts:
      - template: secret.yaml
        exists:
          path: data["tunnel-token"]

  - it: should not include tunnel token when tunnelTokenSecretName is provided
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      manageCloudflared:
        enabled: true
        tunnelTokenSecretName: "my-tunnel-secret"
    asserts:
      - template: secret.yaml
        notExists:
          path: data["tunnel-token"]

  - it: should have correct labels
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
    asserts:
      - template: secret.yaml
        equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: cloudflare-tunnel-gateway-controller
      - template: secret.yaml
        equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  - it: should base64 encode api token
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "my-secret-token"
    asserts:
      - template: secret.yaml
        equal:
          path: data["api-token"]
          value: "bXktc2VjcmV0LXRva2Vu"

  - it: should base64 encode tunnel token
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      manageCloudflared:
        enabled: true
        tunnelToken: "my-tunnel-token"
    asserts:
      - template: secret.yaml
        equal:
          path: data["tunnel-token"]
          value: "bXktdHVubmVsLXRva2Vu"

  - it: should not create secret when both apiTokenSecretName and tunnelTokenSecretName are provided
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiTokenSecretName: "my-api-secret"
      manageCloudflared:
        enabled: true
        tunnelTokenSecretName: "my-tunnel-secret"
    asserts:
      - template: secret.yaml
        hasDocuments:
          count: 0

  - it: should create secret with only api-token when apiToken provided but tunnelTokenSecretName used
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      manageCloudflared:
        enabled: true
        tunnelTokenSecretName: "my-tunnel-secret"
    asserts:
      - template: secret.yaml
        hasDocuments:
          count: 1
      - template: secret.yaml
        exists:
          path: data["api-token"]
      - template: secret.yaml
        notExists:
          path: data["tunnel-token"]

  - it: should work with fullnameOverride
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      fullnameOverride: "my-custom-secret"
    asserts:
      - template: secret.yaml
        equal:
          path: metadata.name
          value: my-custom-secret

  - it: should work with nameOverride
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      nameOverride: "cf-ctrl"
    asserts:
      - template: secret.yaml
        equal:
          path: metadata.name
          value: RELEASE-NAME-cf-ctrl
