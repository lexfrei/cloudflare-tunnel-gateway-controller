suite: test schema validation
templates:
  - deployment.yaml
  - gatewayclassconfig.yaml
tests:
  # Note: These tests verify that schema validation works correctly.
  # Schema validation happens BEFORE template rendering in Helm,
  # so invalid values will be caught by values.schema.json.

  - it: should create deployment with default values
    set:
      gatewayClassConfig:
        create: false
    asserts:
      - template: deployment.yaml
        isKind:
          of: Deployment

  - it: should create gatewayclassconfig with valid tunnelID
    set:
      gatewayClassConfig:
        create: true
        tunnelID: "550e8400-e29b-41d4-a716-446655440000"
        cloudflareCredentialsSecretRef:
          name: "cf-credentials"
    asserts:
      - template: gatewayclassconfig.yaml
        isKind:
          of: GatewayClassConfig
      - template: gatewayclassconfig.yaml
        equal:
          path: spec.tunnelID
          value: "550e8400-e29b-41d4-a716-446655440000"

  # tunnelID must be a valid UUID matching the CRD pattern:
  # ^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$
  - it: should accept lowercase UUID tunnelID
    set:
      gatewayClassConfig:
        create: true
        tunnelID: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
        cloudflareCredentialsSecretRef:
          name: "cf-credentials"
    asserts:
      - template: gatewayclassconfig.yaml
        equal:
          path: spec.tunnelID
          value: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"

  - it: should accept another valid UUID tunnelID
    set:
      gatewayClassConfig:
        create: true
        tunnelID: "12345678-1234-1234-1234-123456789012"
        cloudflareCredentialsSecretRef:
          name: "cf-credentials"
    asserts:
      - template: gatewayclassconfig.yaml
        equal:
          path: spec.tunnelID
          value: "12345678-1234-1234-1234-123456789012"

  - it: should set cloudflared replicas
    set:
      gatewayClassConfig:
        create: true
        tunnelID: "00000000-0000-0000-0000-000000000001"
        cloudflareCredentialsSecretRef:
          name: "cf-credentials"
        cloudflared:
          replicas: 3
    asserts:
      - template: gatewayclassconfig.yaml
        equal:
          path: spec.cloudflared.replicas
          value: 3

  - it: should set cloudflared protocol
    set:
      gatewayClassConfig:
        create: true
        tunnelID: "00000000-0000-0000-0000-000000000002"
        cloudflareCredentialsSecretRef:
          name: "cf-credentials"
        cloudflared:
          protocol: "quic"
    asserts:
      - template: gatewayclassconfig.yaml
        equal:
          path: spec.cloudflared.protocol
          value: "quic"

  - it: should set AWG configuration
    set:
      gatewayClassConfig:
        create: true
        tunnelID: "00000000-0000-0000-0000-000000000003"
        cloudflareCredentialsSecretRef:
          name: "cf-credentials"
        cloudflared:
          awg:
            secretName: "awg-config"
            interfacePrefix: "custom-awg"
    asserts:
      - template: gatewayclassconfig.yaml
        equal:
          path: spec.cloudflared.awg.secretName
          value: "awg-config"
      - template: gatewayclassconfig.yaml
        equal:
          path: spec.cloudflared.awg.interfacePrefix
          value: "custom-awg"

  - it: should not create gatewayclassconfig when disabled
    set:
      gatewayClassConfig:
        create: false
    asserts:
      - template: gatewayclassconfig.yaml
        hasDocuments:
          count: 0
