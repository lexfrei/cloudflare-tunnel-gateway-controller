# AmneziaWG sidecar example
# Route traffic through AmneziaWG VPN tunnel
#
# Prerequisites:
#   1. Create a secret with AWG configuration:
#      kubectl create secret generic awg-config \
#        --namespace cloudflare-tunnel-system \
#        --from-file=wg0.conf=/path/to/your/awg.conf
#
#   2. Create a secret with the API token:
#      kubectl create secret generic cloudflare-credentials \
#        --namespace cloudflare-tunnel-system \
#        --from-literal=api-token="your-api-token"
#
#   3. Create a secret with the tunnel token:
#      kubectl create secret generic cloudflare-tunnel-token \
#        --namespace cloudflare-tunnel-system \
#        --from-literal=tunnel-token="your-tunnel-token"
#
# IMPORTANT: AWG sidecar requires elevated privileges (NET_ADMIN capability)
# to manage network interfaces. This configuration relaxes security defaults.
#
# Usage:
#   helm install cloudflare-tunnel-gateway-controller \
#     oci://ghcr.io/lexfrei/cloudflare-tunnel-gateway-controller/chart \
#     --namespace cloudflare-tunnel-system \
#     --create-namespace \
#     --values awg-sidecar-values.yaml

gatewayClassConfig:
  create: true

  # Cloudflare Tunnel ID (required)
  tunnelID: "your-tunnel-id"

  # Reference to Secret containing Cloudflare API credentials
  cloudflareCredentialsSecretRef:
    name: "cloudflare-credentials"

  # Reference to Secret containing tunnel token
  tunnelTokenSecretRef:
    name: "cloudflare-tunnel-token"

  # Cloudflared deployment configuration
  cloudflared:
    enabled: true
    replicas: 1
    namespace: "cloudflare-tunnel-system"

    # AWG sidecar configuration
    awg:
      # Secret name containing AWG configuration (enables AWG sidecar)
      secretName: "awg-config"
      # AWG interface name prefix (kernel auto-numbers: prefix0, prefix1, etc.)
      # Use different prefixes for different GatewayClassConfigs to avoid conflicts
      interfacePrefix: "awg-cfd"

# Required security context for AWG - needs NET_ADMIN capability
podSecurityContext:
  runAsNonRoot: false
  runAsUser: 0

securityContext:
  allowPrivilegeEscalation: true
  capabilities:
    add:
      - NET_ADMIN
    drop: []
  readOnlyRootFilesystem: false
